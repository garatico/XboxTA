---
title: "XboxTA"
author: "Giovanni Aratico"
date: "2023-05-25"
output: github_document
---

# GOAL:
- Analyze time series of achievement histories of a sample of profiles. 
- Can we forecast user engagement?
- Can we predict customer churn?

```{r Setup, include=FALSE} 
set.seed(196)
library(tidyverse)
library(tidymodels)
library(lubridate)
library(forecast)
library(shiny)
library(xgboost)
library(data.table)
library(caret)
library(stats)

source("./src/r/file.R")
source("./src/r/plots/plots.R")
source("./src/r/transformations/feature_transformations.R")
source("./src/r/variables/variables.R")
source("./src/r/models/models.R")
```

# Read Files and Create Manifests

Gets file directories of all CSVs to pull for analysis. Load the full leaderboard of TA for exploratory data analysis. Read the full achievements manifest for later analysis. We take a sample of 200 profiles and order them. 

```{r File Directories / Manifest}
set.seed(196)
directory_df = create_file_directory()
lb_df = read.csv("./data/leaderboard/leaderboard.csv")
achievements_manifest = read.csv("./data/manifest/achievements_manifest.csv")

# Sample and sort gamers
rnd_gamer_sample = sample_random_gamers(200, directory_df = directory_df)
rnd_gamer_sample = lapply(rnd_gamer_sample, function(x) x[order(rnd_gamer_sample[[3]])])

rm(create_file_directory)
```

# Achievement Transformations
- Removes character entries for achievement earned. 
- Formats date and adds formatted columns for month, day of year and isoweek. 
- Creates column for tracking weekend / weekday

# Game Transformations
- Removes entries with unattainable values. 
- Extracts hours and minutes and splits columns
- Splits app hours from game hours

```{r Feature Transformations}
#lb_df = lb_feature_transformations(lb_df)
rnd_gamer_sample[[1]] = achievement_transform_dates(rnd_gamer_sample[[1]])
rnd_gamer_sample[[2]] = games_transform_hours(rnd_gamer_sample[[2]])
```

```{r Metrics Preprocessing (Total / Frequency)}
print(paste("TOTAL OBSERVATIONS:", get_total_observations(rnd_gamer_sample[[1]])))
metrics_df = process_metrics_df(rnd_gamer_sample, directory_df)

frequency_dfs = achievement_calculate_frequencies(rnd_gamer_sample)
frequency_combined_df = bind_rows(frequency_dfs, .id = "data_frame_id")
frequency_combined_df$data_frame_id = as.numeric(frequency_combined_df$data_frame_id)

rm(directory_df)
```

```{r Metrics Preprocessing (Daily Achievements)}
da_df = calculate_daily_achievements(frequency_combined_df)
da_df = da_fill_dates2(da_df)

da_profiles = da_split_by_profile2(da_df)
da_profiles = da_profiles_set_churn(da_profiles)
da_profiles = da_profiles_set_days_existence(da_profiles)
da_profiles = calculate_daily_lt_eir(da_profiles)
da_profiles = calculate_weekly_eir_all2(da_profiles)
da_profiles = calculate_monthly_eir_all2(da_profiles)

rm(frequency_dfs)
rm(frequency_combined_df)
```

```{r EDA Leaderboard}
plot_lb_range(lb_df, "Score", 0, 4000000, 50000, 1000000)

plot_lb_range(lb_df, "Score", 0, 250000, 10000, 25000)
plot_lb_range(lb_df, "Score", 250000, 500000, 10000, 25000)
plot_lb_range(lb_df, "Score", 500000, 1000000, 50000, 50000)
plot_lb_range(lb_df, "Score", 1000000, 2000000, 50000, 100000)
```

```{r EDA Profiles Plot}
# Define UI
ui <- fluidPage(
  titlePanel("Gamer Achievement Frequencies"),
  
  sidebarLayout(
    sidebarPanel(
      numericInput("index", "Select Frequency Index",
                   value = 1, min = 1, max = length(frequency_dfs)),
      radioButtons("plotType", "Select Plot Type",
                  choices = c("Year", "Month", "Month-Year", "Week", "Weekday"),
                  selected = "Year")
    ),
    
    mainPanel(
      plotOutput("achievementPlot")
    )
  )
)

# Define server
server <- function(input, output) {
  
  # Render plot based on selected plot type and frequency index
  output$achievementPlot <- renderPlot({
    index <- input$index
    plotType <- input$plotType
    
    # Choose the appropriate plot function based on the selected plot type
    if (plotType == "Year") {
      plot_gamer_achievement_freq_year(frequency_dfs[[index]])
    } else if (plotType == "Month") {
      plot_gamer_achievement_freq_month(frequency_dfs[[index]])
    } else if (plotType == "Month-Year") {
      plot_gamer_achievement_freq_month_year(frequency_dfs[[index]])
    } else if (plotType == "Week") {
      plot_gamer_achievement_freq_week(frequency_dfs[[index]])
    } else if (plotType == "Weekday") {
      plot_gamer_achievement_freq_weekday(frequency_dfs[[index]])
    }
  })
}

# Run the app
shinyApp(ui = ui, server = server)
```

```{r EDA Profiles Achievement Variables Plots}
# Plot histogram of churned with different colors for TRUE, FALSE, and NA
ggplot(metrics_df, aes(x = churned, fill = factor(churned))) +
  geom_bar(color = "white") +
  scale_fill_manual(values = c("darkgreen", "darkred", "gray")) +
  labs(title = "Churned Histogram", x = "Churned (365 days since last achievement)", y = "Count")

ggplot(metrics_df, aes(x = longest_streak, fill = factor(longest_streak))) +
  geom_bar(color = "white") +
  labs(title = "Streak Histogram", x = "Longest Streak (in Days)", y = "Count")

# Scatter plot
ggplot(metrics_df, aes(x = longest_gap_within, y = total_game_time_minutes)) +
  geom_point() +
  labs(x = "Longest Gap Within", y = "Total Game Time (Minutes)") +
  ggtitle("Scatter Plot: Longest Gap Within vs. Total Game Time (Minutes)")

ggplot(metrics_df, aes(x = average_interval, y = total_game_time_minutes)) +
  geom_point() +
  labs(x = "Average Interval between Achievements (Daily) ", y = "Total Game Time (Minutes)") +
  ggtitle("Scatter Plot: Average Interval between Achievements (Daily) vs. Total Game Time (Minutes)")

ggplot(metrics_df, aes(x = median_interval, y = total_game_time_minutes)) +
  geom_point() +
  labs(x = "Median Interval between Achievements (Daily) ", y = "Total Game Time (Minutes)") +
  ggtitle("Scatter Plot: Median Interval between Achievements (Daily) vs. Total Game Time (Minutes)")

```

```{r RQ1 : Time Series Decomposition}
ts_profiles <- lapply(seq_along(da_profiles), function(i) {
  profile <- da_profiles[[i]]
  profile <- profile %>% arrange(date)

  ts_objs <- list(
    ts(profile$daily_lt_eir, frequency = 366, start = c(profile$year[1], profile$day_of_year[1])),
    ts(profile$weekly_eir, frequency = 366, start = c(profile$year[1], profile$week[1])),
    ts(profile$monthly_eir, frequency = 366, start = c(profile$year[1], profile$month.x[1])),
    ts(profile$days_since_achievement, frequency = 366, start = c(profile$year[1], profile$day_of_year[1])),
    ts(profile$churn_binary, frequency = 366, start = c(profile$year[1], profile$day_of_year[1]))
  )
  
  decompositions <- lapply(ts_objs, function(ts_obj) {
    if (length(ts_obj) >= 2 * 366) {
      decompose(ts_obj)
    } else {
      NULL
    }
  })
  
  if (all(sapply(decompositions, is.null))) {
    print(paste("Insufficient data for profile", i, "- skipping decomposition."))
    return(NULL)
  } else {
    return(list(
      profile = profile,
      ts = ts_objs,
      decomposition = decompositions
    ))
  }
})

```

```{r RQ1 : Time Series Decomposition Plots Shiny}
# Define UI
ui <- fluidPage(
  titlePanel("Time Series Decomposition Plots"),
  sidebarLayout(
    sidebarPanel(
      selectInput("profile", "Select Profile:", choices = seq_along(ts_profiles), selected = ts_profiles[[1]], width = "25%")
    ),
    mainPanel(
      plotOutput("plot1"),
      plotOutput("plot2"),
      plotOutput("plot3"),
      plotOutput("plot4")
    )
  )
)

# Define server
server <- function(input, output) {
  output$plot1 <- renderPlot({
    profile <- ts_profiles[[as.numeric(input$profile)]]
    plot_data <- data.frame(
      date = time(profile$ts[[1]]),
      stringsAsFactors = FALSE
    )
    plot_data$original1 <- profile$ts[[1]]
    plot_data$trend1 <- profile$decomposition[[1]][["trend"]]
    plot_data$seasonal1 <- profile$decomposition[[1]][["seasonal"]]
    plot_data$residual1 <- profile$decomposition[[1]][["random"]]
    
    ggplot(plot_data, aes(x = date)) +
      geom_line(aes(y = original1, color = "Original")) +
      geom_line(aes(y = trend1, color = "Trend")) +
      geom_line(aes(y = seasonal1, color = "Seasonal")) +
      geom_line(aes(y = residual1, color = "Residual")) +
      labs(x = "Date", y = "Value", color = "Component") +
      scale_color_manual(values = c("Original" = "black", "Trend" = "blue",
                                    "Seasonal" = "red", "Residual" = "green")) +
      facet_wrap(~ "Time Series 1: Daily Lifetime EIR", ncol = 1) +
      theme_minimal()
  })
  
  output$plot2 <- renderPlot({
    profile <- ts_profiles[[as.numeric(input$profile)]]
    plot_data <- data.frame(
      date = time(profile$ts[[2]]),
      stringsAsFactors = FALSE
    )
    plot_data$original2 <- profile$ts[[2]]
    plot_data$trend2 <- profile$decomposition[[2]][["trend"]]
    plot_data$seasonal2 <- profile$decomposition[[2]][["seasonal"]]
    plot_data$residual2 <- profile$decomposition[[2]][["random"]]
    
    ggplot(plot_data, aes(x = date)) +
      geom_line(aes(y = original2, color = "Original")) +
      geom_line(aes(y = trend2, color = "Trend")) +
      geom_line(aes(y = seasonal2, color = "Seasonal")) +
      geom_line(aes(y = residual2, color = "Residual")) +
      labs(x = "Date", y = "Value", color = "Component") +
      scale_color_manual(values = c("Original" = "black", "Trend" = "blue",
                                    "Seasonal" = "red", "Residual" = "green")) +
      facet_wrap(~ "Time Series 2: Weekly EIR", ncol = 1) +
      theme_minimal()
  })
  
  output$plot3 <- renderPlot({
    profile <- ts_profiles[[as.numeric(input$profile)]]
    plot_data <- data.frame(
      date = time(profile$ts[[3]]),
      stringsAsFactors = FALSE
    )
    plot_data$original3 <- profile$ts[[3]]
    plot_data$trend3 <- profile$decomposition[[3]][["trend"]]
    plot_data$seasonal3 <- profile$decomposition[[3]][["seasonal"]]
    plot_data$residual3 <- profile$decomposition[[3]][["random"]]
    
    ggplot(plot_data, aes(x = date)) +
      geom_line(aes(y = original3, color = "Original")) +
      geom_line(aes(y = trend3, color = "Trend")) +
      geom_line(aes(y = seasonal3, color = "Seasonal")) +
      geom_line(aes(y = residual3, color = "Residual")) +
      labs(x = "Date", y = "Value", color = "Component") +
      scale_color_manual(values = c("Original" = "black", "Trend" = "blue",
                                    "Seasonal" = "red", "Residual" = "green")) +
      facet_wrap(~ "Time Series 3: Monthly EIR", ncol = 1) +
      theme_minimal()
  })
  
  output$plot4 <- renderPlot({
    profile <- ts_profiles[[as.numeric(input$profile)]]
    plot_data <- data.frame(
      date = time(profile$ts[[4]]),
      stringsAsFactors = FALSE
    )
    plot_data$original4 <- profile$ts[[4]]
    plot_data$trend4 <- profile$decomposition[[4]][["trend"]]
    plot_data$seasonal4 <- profile$decomposition[[4]][["seasonal"]]
    plot_data$residual4 <- profile$decomposition[[4]][["random"]]
    
    ggplot(plot_data, aes(x = date)) +
      geom_line(aes(y = original4, color = "Original")) +
      geom_line(aes(y = trend4, color = "Trend")) +
      geom_line(aes(y = seasonal4, color = "Seasonal")) +
      geom_line(aes(y = residual4, color = "Residual")) +
      labs(x = "Date", y = "Value", color = "Component") +
      scale_color_manual(values = c("Original" = "black", "Trend" = "blue",
                                    "Seasonal" = "red", "Residual" = "green")) +
      facet_wrap(~ "Time Series 4: Days Since Achievement Earned", ncol = 1) +
      theme_minimal()
  })
}

# Run the Shiny app
shinyApp(ui = ui, server = server)



```

RQ1 : Hyperparameters
Cross Folds = 5, 10, 25
Nrounds = 100, 1000

```{r RQ1 : Model Preparation}
ts_profiles <- ts_profiles %>% keep(~ !is.null(.))

# Initialize empty lists for data and dtrain
t1_data_list <- list()
t1_dtrain_list <- list()

t2_data_list = list()
t2_dtrain_list = list()

t3_data_list = list()
t3_dtrain_list = list()

t4_data_list = list()
t4_dtrain_list = list()

t5_data_list = list()
t5_dtrain_list = list()

for (i in 1:length(ts_profiles)) {
  for (j in 1:5) {  # Loop over target variables (j = 1 for ts[[1]], j = 2 for ts[[2]])
    # Extract the target variable (daily_lt_eir) and create lagged variables as features
    target <- as.vector(ts_profiles[[i]][["ts"]][[j]])
    # Add a small constant to handle zero values and apply log transformation
    #target_transformed <- log(target + 1e-6)
    lag_1day = lag(target, 1)
    lag_1week = lag(target, 7)
    lag_2week = lag(target, 14)
    lag_1month = lag(target, 28)
    year = ts_profiles[[i]][["profile"]][["year"]]
    month.x = ts_profiles[[i]][["profile"]][["month.x"]]
    day_of_year = ts_profiles[[i]][["profile"]][["day_of_year"]]
    week = ts_profiles[[i]][["profile"]][["week"]]
    
    # Combine the features and target into a data frame
    data <- data.frame(target, year, month.x, day_of_year, week, lag_1day, lag_1week, lag_2week, lag_1month)
    data <- na.omit(data)  # Remove rows with missing values
    
    # Convert the data to DMatrix format
    dtrain <- xgb.DMatrix(data = as.matrix(data[, -1]), label = data[, 1])
    
    # Add the data and dtrain to their respective lists
    if (j == 1) {
      t1_data_list[[i]] <- data
      t1_dtrain_list[[i]] <- dtrain
    } else if (j == 2) {
      t2_data_list[[i]] <- data
      t2_dtrain_list[[i]] <- dtrain
    } else if (j == 3) {
      t3_data_list[[i]] <- data
      t3_dtrain_list[[i]] <- dtrain
    } else if (j == 4) {
      t4_data_list[[i]] <- data
      t4_dtrain_list[[i]] <- dtrain
    } else if (j == 5) {
      t5_data_list[[i]] <- data
      t5_dtrain_list[[i]] <- dtrain
    }
  }
}

rm(data)
rm(dtrain)
```

```{r RQ1 : Cross Validation Create Folds}
t1_5fold_full = get_cv_folds(t1_data_list, 5)
t1_10fold_full = get_cv_folds(t1_data_list, 10)
t1_25fold_full = get_cv_folds(t1_data_list, 25)

# Assuming you have an xgb.DMatrix called "dtrain"
t1_params <- list(
  objective = "reg:squarederror",
  eval_metric = "rmse",
  max_depth = 8,
  eta = 0.1,
  subsample = 0.8,
  colsample_bytree = 0.8
)
```

```{r RQ1 : Model Train 100n}
# 100 BOOST ROUNDS
t1_5fold_100n_models = lapply(1:189, function(index) train_cv_target1_models(index, t1_5fold_full, t1_params, t1_data_list, t1_dtrain_list, 100))
t1_10fold_100n_models = lapply(1:189, function(index) train_cv_target1_models(index, t1_10fold_full, t1_params, t1_data_list, t1_dtrain_list, 100))
t1_25fold_100n_models = lapply(1:189, function(index) train_cv_target1_models(index, t1_25fold_full, t1_params, t1_data_list, t1_dtrain_list, 100))
```

```{r RQ1 : Model Train 1000n}
# 1000 BOOST ROUNDS
#t1_5fold_1000n_models = lapply(1:189, function(index) train_cv_target1_models(index, t1_5fold_full, t1_params, t1_data_list, t1_dtrain_list, 1000))
#t1_10fold_1000n_models = lapply(1:189, function(index) train_cv_target1_models(index, t1_10fold_full, t1_params, t1_data_list, t1_dtrain_list, 1000))
#t1_25fold_1000n_models = lapply(1:189, function(index) train_cv_target1_models(index, t1_25fold_full, t1_params, t1_data_list, t1_dtrain_list, 1000))

```

```{r RQ1 : Performance Metrics Shiny 100n}
# UI
ui <- fluidPage(
  titlePanel("Evaluation Metrics"),
  sidebarLayout(
    sidebarPanel(
      selectInput("profile", "Select Profile:", choices = c(1:189))
    ),
    mainPanel(
      plotOutput("t1_5fold_100n_metrics_plot"),
      plotOutput("t1_10fold_100n_metrics_plot"),
      plotOutput("t1_25fold_100n_metrics_plot"),
      tableOutput("mean_metrics")
    )
  )
)

# Server
server <- function(input, output, session) {
  output$t1_5fold_100n_metrics_plot <- renderPlot({
    profile <- as.integer(input$profile)
    # Create a data frame with the evaluation metrics for the selected profile
    t1_5fold_100n_metrics_df <- data.frame(
      Fold = 1:length(t1_5fold_100n_models[[profile]][[3]][[1]]),
      RMSE = t1_5fold_100n_models[[profile]][[3]][[1]],
      MAPE = t1_5fold_100n_models[[profile]][[3]][[2]],
      SMAPE = t1_5fold_100n_models[[profile]][[3]][[3]]
    )
    # Plot the evaluation metrics
    ggplot(t1_5fold_100n_metrics_df, aes(x = Fold)) +
      geom_line(aes(y = RMSE, color = "RMSE"), size = 1) +
      geom_line(aes(y = MAPE, color = "MAPE"), size = 1) +
      geom_line(aes(y = SMAPE, color = "SMAPE"), size = 1) +
      labs(title = paste("Evaluation Metrics (5 Fold) - Profile", profile),
           x = "Fold",
           y = "Value",
           color = "Metric") +
      scale_color_manual(values = c("RMSE" = "red", "MAPE" = "blue", "SMAPE" = "green")) +
      theme_minimal()
  })
  output$t1_10fold_100n_metrics_plot <- renderPlot({
    profile <- as.integer(input$profile)
    # Create a data frame with the evaluation metrics for the selected profile
    t1_10fold_100n_metrics_df <- data.frame(
      Fold = 1:length(t1_10fold_100n_models[[profile]][[3]][[1]]),
      RMSE = t1_10fold_100n_models[[profile]][[3]][[1]],
      MAPE = t1_10fold_100n_models[[profile]][[3]][[2]],
      SMAPE = t1_10fold_100n_models[[profile]][[3]][[3]]
    )
    # Plot the evaluation metrics
    ggplot(t1_10fold_100n_metrics_df, aes(x = Fold)) +
      geom_line(aes(y = RMSE, color = "RMSE"), size = 1) +
      geom_line(aes(y = MAPE, color = "MAPE"), size = 1) +
      geom_line(aes(y = SMAPE, color = "SMAPE"), size = 1) +
      labs(title = paste("Evaluation Metrics (10 Fold) - Profile", profile),
           x = "Fold",
           y = "Value",
           color = "Metric") +
      scale_color_manual(values = c("RMSE" = "red", "MAPE" = "blue", "SMAPE" = "green")) +
      theme_minimal()
  })
  output$t1_25fold_100n_metrics_plot <- renderPlot({
    profile <- as.integer(input$profile)
    # Create a data frame with the evaluation metrics for the selected profile
    t1_25fold_100n_metrics_df <- data.frame(
      Fold = 1:length(t1_25fold_100n_models[[profile]][[3]][[1]]),
      RMSE = t1_25fold_100n_models[[profile]][[3]][[1]],
      MAPE = t1_25fold_100n_models[[profile]][[3]][[2]],
      SMAPE = t1_25fold_100n_models[[profile]][[3]][[3]]
    )
    # Plot the evaluation metrics
    ggplot(t1_25fold_100n_metrics_df, aes(x = Fold)) +
      geom_line(aes(y = RMSE, color = "RMSE"), size = 1) +
      geom_line(aes(y = MAPE, color = "MAPE"), size = 1) +
      geom_line(aes(y = SMAPE, color = "SMAPE"), size = 1) +
      labs(title = paste("Evaluation Metrics (25 Fold) - Profile", profile),
           x = "Fold",
           y = "Value",
           color = "Metric") +
      scale_color_manual(values = c("RMSE" = "red", "MAPE" = "blue", "SMAPE" = "green")) +
      theme_minimal()
  })
  output$mean_metrics <- renderTable({
  profile <- as.integer(input$profile)
  
  # Create a data frame with the mean metrics for the selected profile
  mean_metrics_df <- data.frame(
    Metric = rep(c("Mean RMSE", "Mean MAPE", "Mean SMAPE"), times = 3),
    Value = c(
      t1_5fold_100n_models[[profile]][[4]],
      t1_5fold_100n_models[[profile]][[5]],
      t1_5fold_100n_models[[profile]][[6]],
      t1_10fold_100n_models[[profile]][[4]],
      t1_10fold_100n_models[[profile]][[5]],
      t1_10fold_100n_models[[profile]][[6]],
      t1_25fold_100n_models[[profile]][[4]],
      t1_25fold_100n_models[[profile]][[5]],
      t1_25fold_100n_models[[profile]][[6]]
    ),
    Fold = rep(c("5-fold", "10-fold", "25-fold"), each = 3)
  )
  
  mean_metrics_df
})

}

# Run the Shiny app
shinyApp(ui = ui, server = server)

```

```{r RQ1 : Performance Metrics Shiny 1000n}
# UI
ui <- fluidPage(
  titlePanel("Evaluation Metrics"),
  sidebarLayout(
    sidebarPanel(
      selectInput("profile", "Select Profile:", choices = c(1:189))
    ),
    mainPanel(
      plotOutput("t1_5fold_1000n_metrics_plot"),
      plotOutput("t1_10fold_1000n_metrics_plot"),
      plotOutput("t1_25fold_1000n_metrics_plot"),
      tableOutput("mean_metrics")
    )
  )
)

# Server
server <- function(input, output, session) {
  output$t1_5fold_1000n_metrics_plot <- renderPlot({
    profile <- as.integer(input$profile)
    # Create a data frame with the evaluation metrics for the selected profile
    t1_5fold_1000n_metrics_df <- data.frame(
      Fold = 1:length(t1_5fold_1000n_models[[profile]][[3]][[1]]),
      RMSE = t1_5fold_1000n_models[[profile]][[3]][[1]],
      MAPE = t1_5fold_1000n_models[[profile]][[3]][[2]],
      SMAPE = t1_5fold_100n_models[[profile]][[3]][[3]]
    )
    # Plot the evaluation metrics
    ggplot(t1_5fold_1000n_metrics_df, aes(x = Fold)) +
      geom_line(aes(y = RMSE, color = "RMSE"), size = 1) +
      geom_line(aes(y = MAPE, color = "MAPE"), size = 1) +
      geom_line(aes(y = SMAPE, color = "SMAPE"), size = 1) +
      labs(title = paste("Evaluation Metrics - Profile", profile),
           x = "Fold",
           y = "Value",
           color = "Metric") +
      scale_color_manual(values = c("RMSE" = "red", "MAPE" = "blue", "SMAPE" = "green")) +
      theme_minimal()
  })
  output$t1_10fold_1000n_metrics_plot <- renderPlot({
    profile <- as.integer(input$profile)
    # Create a data frame with the evaluation metrics for the selected profile
    t1_10fold_1000n_metrics_df <- data.frame(
      Fold = 1:length(t1_10fold_1000n_models[[profile]][[3]][[1]]),
      RMSE = t1_10fold_1000n_models[[profile]][[3]][[1]],
      MAPE = t1_10fold_1000n_models[[profile]][[3]][[2]],
      SMAPE = t1_10fold_1000n_models[[profile]][[3]][[3]]
    )
    # Plot the evaluation metrics
    ggplot(t1_10fold_1000n_metrics_df, aes(x = Fold)) +
      geom_line(aes(y = RMSE, color = "RMSE"), size = 1) +
      geom_line(aes(y = MAPE, color = "MAPE"), size = 1) +
      geom_line(aes(y = SMAPE, color = "SMAPE"), size = 1) +
      labs(title = paste("Evaluation Metrics - Profile", profile),
           x = "Fold",
           y = "Value",
           color = "Metric") +
      scale_color_manual(values = c("RMSE" = "red", "MAPE" = "blue", "SMAPE" = "green")) +
      theme_minimal()
  })
  output$t1_25fold_1000n_metrics_plot <- renderPlot({
    profile <- as.integer(input$profile)
    # Create a data frame with the evaluation metrics for the selected profile
    t1_25fold_1000n_metrics_df <- data.frame(
      Fold = 1:length(t1_25fold_1000n_models[[profile]][[3]][[1]]),
      RMSE = t1_25fold_1000n_models[[profile]][[3]][[1]],
      MAPE = t1_25fold_1000n_models[[profile]][[3]][[2]],
      SMAPE = t1_25fold_1000n_models[[profile]][[3]][[3]]
    )
    # Plot the evaluation metrics
    ggplot(t1_25fold_1000n_metrics_df, aes(x = Fold)) +
      geom_line(aes(y = RMSE, color = "RMSE"), size = 1) +
      geom_line(aes(y = MAPE, color = "MAPE"), size = 1) +
      geom_line(aes(y = SMAPE, color = "SMAPE"), size = 1) +
      labs(title = paste("Evaluation Metrics - Profile", profile),
           x = "Fold",
           y = "Value",
           color = "Metric") +
      scale_color_manual(values = c("RMSE" = "red", "MAPE" = "blue", "SMAPE" = "green")) +
      theme_minimal()
  })
  output$mean_metrics <- renderTable({
    profile <- as.integer(input$profile)
    
    # Create a data frame with the mean metrics for the selected profile
    mean_metrics_df <- data.frame(
      Metric = c("Mean RMSE", "Mean RMSE", "Mean RMSE", "Mean MAPE", "Mean MAPE", "Mean MAPE", "Mean SMAPE", "Mean SMAPE", "Mean SMAPE"),
      Value = c(
        t1_5fold_1000n_models[[profile]][[4]],
        t1_10fold_1000n_models[[profile]][[4]],
        t1_25fold_1000n_models[[profile]][[4]],
        t1_5fold_1000n_models[[profile]][[5]],
        t1_10fold_1000n_models[[profile]][[5]],
        t1_25fold_1000n_models[[profile]][[5]],
        t1_5fold_1000n_models[[profile]][[6]],
        t1_10fold_1000n_models[[profile]][[6]],
        t1_25fold_1000n_models[[profile]][[6]]
      ),
      Fold = rep(c("5-fold", "10-fold", "25-fold"), each = 3)
    )
    
    mean_metrics_df
  })
}

# Run the Shiny app
shinyApp(ui = ui, server = server)

```

```{r RQ2 : Churn Cross Validation Folds}
t5_5fold_full = get_cv_folds(t5_data_list, 5)
t5_10fold_full = get_cv_folds(t5_data_list, 10)
t5_25fold_full = get_cv_folds(t5_data_list, 25)

t5_params <- list(
  objective = "binary:logistic",  # Set the objective to binary:logistic
  eval_metric = "logloss",        # Use logloss as the evaluation metric
  max_depth = 8,
  eta = 0.1,
  subsample = 0.8,
  colsample_bytree = 0.8
)
```

```{r RQ2 : Churn Train 100n}
t5_25fold_100n_models = lapply(1:189, function(index) train_cv_target5_models(index, t5_25fold_full, t5_params, t5_data_list, t5_dtrain_list, 100))
```

```{r RQ2 : Churn Metrics Summed}
# Create a data frame with the summed metrics
summed_metrics_df <- data.frame(
  Profile_Index = 1:189,
  Summed_Accuracy = summed_accuracy,
  Summed_Precision = summed_precision,
  Summed_Recall = summed_recall,
  Summed_F1_Score = summed_f1_score
)

# Function to plot a single metric
plot_summed_metric <- function(metric_name) {
  metric_plot <- ggplot(summed_metrics_df, aes(x = reorder(Profile_Index, .data[[metric_name]]), y = .data[[metric_name]])) +
    geom_bar(stat = "identity", fill = "skyblue") +
    labs(x = "Profile Index", y = metric_name) +
    ggtitle(paste("Summed", metric_name)) +
    theme_minimal()
  
  print(metric_plot)
}

# Plot each metric separately
plot_summed_metric("Summed_Accuracy")
plot_summed_metric("Summed_Precision")
plot_summed_metric("Summed_Recall")
plot_summed_metric("Summed_F1_Score")

```

```{r RQ2 : Churn Performance Metrics Shiny 100n}
# UI
ui <- fluidPage(
  titlePanel("Evaluation Metrics"),
  sidebarLayout(
    sidebarPanel(
      selectInput("profile", "Select Profile:", choices = c(1:189))
    ),
    mainPanel(
      plotOutput("t5_25fold_100n_metrics_plot"),
      tableOutput("mean_metrics")
    )
  )
)

# Server
server <- function(input, output, session) {
  output$t5_25fold_100n_metrics_plot <- renderPlot({
    profile <- as.integer(input$profile)
    # Create a data frame with the evaluation metrics for the selected profile
    t5_25fold_100n_metrics_df <- data.frame(
      Fold = 1:length(t5_25fold_100n_models[[profile]][[3]][[1]]),
      Accuracy = t5_25fold_100n_models[[profile]][[3]][[1]],
      Precision = t5_25fold_100n_models[[profile]][[3]][[2]],
      Recall = t5_25fold_100n_models[[profile]][[3]][[3]]
    )
    # Plot the evaluation metrics
    ggplot(t5_25fold_100n_metrics_df, aes(x = Fold)) +
      geom_line(aes(y = Accuracy, color = "Accuracy"), size = 1) +
      geom_line(aes(y = Precision, color = "Precision"), size = 1) +
      geom_line(aes(y = Recall, color = "Recall"), size = 1) +
      labs(title = paste("Evaluation Metrics - Profile", profile),
           x = "Fold",
           y = "Value",
           color = "Metric") +
      scale_color_manual(values = c("Accuracy" = "red", "Precision" = "blue", "Recall" = "green")) +
      theme_minimal()
  })
}

# Run the Shiny app
shinyApp(ui = ui, server = server)

```

