---
title: "XboxTA"
author: "Giovanni Aratico"
date: "2023-07-06"
output:
  html_document:
    self_contained: true
    output_file: index.html
---

### GOAL:

-   Analyze time series of achievement histories of a sample of profiles.
-   Can we forecast user engagement?

```{r Setup, include=FALSE}
set.seed(196)
library(tidyverse)
library(tidymodels)
library(lubridate)
library(forecast)
library(shiny)

library(htmlwidgets)
library(widgetframe)
library(plotly)

library(xgboost)
library(data.table)
library(caret)
library(stats)
library(rsconnect)

source("./src/r/file.R")
source("./src/r/plots/plots.R")
source("./src/r/transformations/feature_transformations.R")
source("./src/r/variables/variables.R")
source("./src/r/models/models.R")
```

## Create Files Directory

-   Gets file directories of all CSVs to pull for analysis.
-   Applies transformations for consistent format to dates of last scraped

```{r Create Files Directory}
directory_df = create_file_directory()
directory_df = directory_transformations(directory_df)
```

## Read Manifests

-   Load the full leaderboard of TA for exploratory data analysis.
-   Read the full achievements manifest for later analysis.

```{r Read Manifests}
lb_df = read.csv("./data/leaderboard/leaderboard.csv")
lb_df = lb_feature_transformations(lb_df)
achievements_manifest = read.csv("./data/manifest/achievements_manifest.csv")
```

## Read Sample of Gamers

-   We take a sample of 200 profiles using our file directory and order them.

```{r Sample Random Gamers}
set.seed(196)
rnd_gamer_sample = sample_random_gamers(200, directory_df = directory_df)
rnd_gamer_sample = lapply(rnd_gamer_sample, function(x) x[order(rnd_gamer_sample[[3]])])
```

### Achievement Transformations

-   Removes character entries for achievement earned.
-   Formats date and adds formatted columns for month, day of year and isoweek.
-   Creates column for tracking weekend / weekday

```{r Achievements Transformations}
rnd_gamer_sample[[1]] = achievement_transform_today(rnd_gamer_sample[[1]], directory_df)
rnd_gamer_sample[[1]] = achievement_transform_yesterday(rnd_gamer_sample[[1]], directory_df)
rnd_gamer_sample[[1]] = achievement_transform_drop_offline(rnd_gamer_sample[[1]])
rnd_gamer_sample[[1]] = achievement_transform_format_dates(rnd_gamer_sample[[1]])
rnd_gamer_sample[[1]] = achievement_transform_extract_dates(rnd_gamer_sample[[1]])
```

# Game Transformations

-   Removes entries with unattainable values.
-   Extracts hours and minutes and splits columns
-   Splits app hours from game hours

```{r Game Transformations}
rnd_gamer_sample[[2]] = games_transform_drop_bad_titles(rnd_gamer_sample[[2]])
rnd_gamer_sample[[2]] = games_transform_hours(rnd_gamer_sample[[2]])
```

# Metrics Preprocessing (Total)

-   Outputs total observations
-   Processes the metrics data frame for all profiles

```{r Metrics Preprocessing (Total Metrics)}
print(paste("TOTAL OBSERVATIONS:", get_total_observations(rnd_gamer_sample[[1]])))
metrics_df = process_metrics_df(rnd_gamer_sample, directory_df)
```

# Frequency Data Preprocessing

-   Intermediate Step to analyze each profile in the sample later.

```{r Metrics Preprocessing (Frequency Data)}
frequency_dfs = achievement_calculate_frequencies(rnd_gamer_sample)
frequency_combined_df = bind_rows(frequency_dfs, .id = "data_frame_id")
frequency_combined_df$data_frame_id = as.numeric(frequency_combined_df$data_frame_id)
```

```{r Metrics Preprocessing (Daily Achievements)}
da_df = calculate_daily_achievements(frequency_combined_df)
da_df = da_fill_dates(da_df)

da_profiles = da_split_by_profile(da_df)
da_profiles = da_profiles_set_churn(da_profiles)
da_profiles = da_profiles_set_days_existence(da_profiles)
da_profiles = calculate_daily_lt_eir(da_profiles)
da_profiles = calculate_weekly_eir_all(da_profiles)
da_profiles = calculate_monthly_eir_all(da_profiles)
```

# Leaderboard Frequency Plots

-   Outputs the frequency of score ranges for the entirety of the leaderboard

```{r EDA Leaderboard}
plot_lb_range(lb_df, "Score", 0, 4000000, 50000, 1000000)
plot_lb_range(lb_df, "Score", 0, 250000, 10000, 25000)
plot_lb_range(lb_df, "Score", 250000, 500000, 10000, 25000)
plot_lb_range(lb_df, "Score", 500000, 1000000, 50000, 50000)
plot_lb_range(lb_df, "Score", 1000000, 2000000, 50000, 100000)
```

```{r EDA : Leaderboard Interactive}
plot_lb_range_interactive(lb_df, "Score", 0, 4000000, 50000, 1000000)
```

<!--
# Frequency Plots by Profile

-   Can select the profile and temporal metric
-   **Note:** This Shiny app won't display in the self-contained HTML file. To interact with the app, you can run the RMD document in an R Markdown viewer or in the RStudio IDE.

```{r EDA Profiles Plot, echo = FALSE}
# Define UI
ui <- fluidPage(
  titlePanel("Gamer Achievement Frequencies"),
  
  sidebarLayout(
    sidebarPanel(
      numericInput("index", "Select Frequency Index",
                   value = 1, min = 1, max = length(frequency_dfs)),
      radioButtons("plotType", "Select Plot Type",
                  choices = c("Year", "Month", "Month-Year", "Week", "Weekday"),
                  selected = "Year")
    ),
    
    mainPanel(
      plotOutput("achievementPlot")
    )
  )
)

# Define server
server <- function(input, output) {
  
  # Render plot based on selected plot type and frequency index
  output$achievementPlot <- renderPlot({
    index <- input$index
    plotType <- input$plotType
    
    # Choose the appropriate plot function based on the selected plot type
    if (plotType == "Year") {
      plot_gamer_achievement_freq_year(frequency_dfs[[index]])
    } else if (plotType == "Month") {
      plot_gamer_achievement_freq_month(frequency_dfs[[index]])
    } else if (plotType == "Month-Year") {
      plot_gamer_achievement_freq_month_year(frequency_dfs[[index]])
    } else if (plotType == "Week") {
      plot_gamer_achievement_freq_week(frequency_dfs[[index]])
    } else if (plotType == "Weekday") {
      plot_gamer_achievement_freq_weekday(frequency_dfs[[index]])
    }
  })
}

# Render the Shiny app
shinyApp(ui = ui, server = server)
```
-->

# Churned \@ 365 Days Histogram

-   Most users from this sample, approx. 75% not churned by this definition

```{r EDA : Churned Histogram}
# Plot histogram of churned with different colors for TRUE, FALSE, and NA
ggplot(metrics_df, aes(x = churned, fill = factor(churned))) +
  geom_bar(color = "white") +
  scale_fill_manual(values = c("darkgreen", "darkred", "gray")) +
  labs(title = "Churned Histogram (365 Days Since Last Achievement)", x = "Churned Status", y = "Count")
```

# Longest Streak Histogram

-   Most users have 4 or 5 days as their longest streak.
-   This sample approximates a roughly normal distribution.

```{r EDA : Streak Histogram}
ggplot(metrics_df, aes(x = longest_streak, fill = factor(longest_streak))) +
  geom_bar(color = "white") +
  labs(title = "Streak Histogram", x = "Longest Streak (in Days)", y = "Count")
```

<!--
```{r EDA Profiles Achievement Variables Plots}
# Scatter plot
ggplot(metrics_df, aes(x = longest_gap_within, y = total_game_time_minutes)) +
  geom_point() +
  labs(x = "Longest Gap Within", y = "Total Game Time (Minutes)") +
  ggtitle("Scatter Plot: Longest Gap Within vs. Total Game Time (Minutes)")

ggplot(metrics_df, aes(x = average_interval, y = total_game_time_minutes)) +
  geom_point() +
  labs(x = "Average Interval between Achievements (Daily) ", y = "Total Game Time (Minutes)") +
  ggtitle("Scatter Plot: Average Interval between Achievements (Daily) vs. Total Game Time (Minutes)")

ggplot(metrics_df, aes(x = median_interval, y = total_game_time_minutes)) +
  geom_point() +
  labs(x = "Median Interval between Achievements (Daily) ", y = "Total Game Time (Minutes)") +
  ggtitle("Scatter Plot: Median Interval between Achievements (Daily) vs. Total Game Time (Minutes)")

```

-->
